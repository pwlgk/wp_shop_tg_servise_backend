# Telegram Mini App E-commerce Backend

Этот проект представляет собой сервисный слой (Backend for Frontend) на FastAPI, предназначенный для обслуживания Telegram Mini App интернет-магазина. Он использует WordPress + WooCommerce в качестве headless CMS и e-commerce движка.

## Архитектура

Система построена на принципах headless e-commerce и состоит из трех основных компонентов:

1.  **WordPress + WooCommerce (Мозг):** Выступает в роли админ-панели и хранилища данных. Отвечает за управление товарами, категориями, заказами и базовым контентом (баннеры, информационные страницы). Фронтенд полностью отключен.
2.  **FastAPI Сервис (Сердце):** Основное приложение, которое предоставляет оптимизированный и безопасный REST API для клиентского приложения. Реализует всю кастомную бизнес-логику:
    *   Аутентификация пользователей через Telegram.
    *   Управление корзиной и избранным.
    *   Система лояльности (бонусные баллы, уровни клиентов).
    *   Реферальная программа.
    *   Агрессивное кеширование данных из WordPress в Redis.
    *   Интеграция с Telegram-ботом для уведомлений и администрирования.
3.  **Telegram Mini App (Лицо):** Клиентское веб-приложение (например, на React/Vue/Svelte), которое взаимодействует исключительно с FastAPI сервисом.

## Основные технологии

-   **Бэкенд:** Python, FastAPI
-   **База данных:** PostgreSQL
-   **Кеш:** Redis
-   **Взаимодействие с БД:** SQLAlchemy, Alembic (для миграций)
-   **Telegram Бот:** aiogram 3.x
-   **Запуск в продакшене:** Docker, Gunicorn, Uvicorn
-   **CMS / E-commerce движок:** WordPress + WooCommerce (headless)

## Функционал

### Для пользователя:
-   Полный цикл покупки: от просмотра каталога до оформления заказа.
-   Аутентификация через Telegram.
-   Личный кабинет с историей заказов и бонусным счетом.
-   Многоуровневая система лояльности и реферальная программа.
-   Корзина и список избранного.
-   Просмотр баннеров и информационных страниц.
-   Уведомления в Telegram-бот о статусе заказов и начислении баллов.
-   Возможность диалога с поддержкой через бота.

### Для администратора:
-   Управление товарами, заказами и контентом через админ-панель WordPress.
-   Уведомления о новых заказах в специальный Telegram-чат.
-   Интерактивные кнопки для быстрой реакции на заказ (написать клиенту, ответить от бота, запросить контакт).
-   CRM-система в боте:
    -   Статистика по пользователям (`/stats`).
    -   Поиск пользователей по ID, username, ФИО (`/find_user`).
    -   Пагинированный список пользователей с фильтрами (`/users`).
    -   Блокировка/разблокировка пользователей.
    -   Ручное начисление/списание баллов.
-   Управление акциями и рассылками через команды в боте или админ-панель WordPress.
-   Защищенный REST API для админского Mini App.

---

## Настройка и запуск (для разработки)

### Предварительные требования
-   Python 3.11+
-   Docker и Docker Compose
-   Настроенный WordPress + WooCommerce на удаленном сервере с доступом по API.

### 1. Клонирование репозитория
```bash
git clone <your-repo-url>
cd fastapi-service
```

### 2. Настройка переменных окружения
Создайте файл `.env` в корне проекта, скопировав содержимое из `.env.example`, и заполните его вашими данными.

```bash
cp .env.example .env
nano .env
```
Вам понадобятся:
-   Данные для подключения к PostgreSQL.
-   Данные для подключения к Redis.
-   URL и Application Password от вашего WordPress-сайта.
-   Токен Telegram-бота и другие настройки для интеграции.

### 3. Запуск инфраструктуры
Запустите контейнеры с PostgreSQL и Redis:
```bash
docker-compose up -d
```

### 4. Настройка виртуального окружения Python
```bash
python3 -m venv venv
source venv/bin/activate
pip install --no-cache-dir --upgrade pip
pip install --no-cache-dir -r requirements.txt
```

### 5. Применение миграций базы данных
Перед первым запуском необходимо создать все таблицы в базе данных:
```bash
alembic upgrade head
```
При внесении изменений в модели SQLAlchemy (файлы в `app/models/`), необходимо создавать новую миграцию:
```bash
alembic revision --autogenerate -m "Краткое описание изменений"
alembic upgrade head
```

### 6. Запуск FastAPI-сервиса
```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```
Сервис будет доступен по адресу `http://localhost:8000`. Интерактивная документация API (Swagger UI) будет доступна по `http://localhost:8000/docs`.

### 7. Запуск бота в режиме поллинга (для отладки)
Для тестирования логики бота без необходимости настраивать веб-хуки (ngrok), можно использовать режим поллинга:
```bash
python run_polling.py
```

---

## Структура проекта

```
.
├── alembic/              # Миграции базы данных Alembic
├── app/                  # Основной код приложения
│   ├── bot/              # Логика Telegram-бота (хендлеры, сервисы)
│   ├── clients/          # Клиенты для внешних API (WooCommerce)
│   ├── core/             # Конфигурация, логирование
│   ├── crud/             # Функции для прямого взаимодействия с БД
│   ├── db/               # Настройка сессии SQLAlchemy
│   ├── dependencies.py   # Зависимости FastAPI (аутентификация, сессия БД)
│   ├── models/           # Модели SQLAlchemy (структура таблиц БД)
│   ├── routers/          # Роутеры FastAPI (эндпоинты API)
│   ├── schemas/          # Схемы Pydantic (валидация данных API)
│   ├── services/         # Бизнес-логика приложения
│   └── utils/            # Вспомогательные утилиты
├── .env                  # Локальные переменные окружения (НЕ ДЛЯ GIT)
├── .env.example          # Шаблон для .env (ДЛЯ GIT)
├── Dockerfile            # Инструкция по сборке Docker-образа
├── docker-compose.yml    # Docker Compose для локальной разработки
├── docker-compose.prod.yml # Docker Compose для продакшена
├── README.md             # Этот файл
├── requirements.txt      # Зависимости Python
└── run_polling.py        # Скрипт для запуска бота в режиме поллинга
```
